---
layout: post
title: "[Part 4] Log collection"
location: "Japan"
categories: ["Code"]
comments: true
---

Check out the codes in [GitHub](https://github.com/idrilsilverfoot/win32-etw-manifest).

# Getting the logs

Now that I have my modules spitting out logs for me, it's time to actually consume (or view) them. Most of the time, I use `MFTrace` and `logman` tools.

# MFTrace

Although `MFTrace` is primarily a tool for generating logs for Media Foundation apps, it is a great tool for viewing ETW logs in general as well. It is included in the MS SDK.

To view logs in real time, I use this command in either Powershell or command line:

{% highlight shell %}
mftrace -c config.xml
{% endhighlight %}

To stop the trace collection, press `CTRL+C`.

# logman

`logman` is a very powerful builtin performance counter and event trace log tool from Microsoft. For more information, have a look at [here](https://technet.microsoft.com/en-us/library/bb490956.aspx).

You can use `logman` as alternative to `MFTrace`.

## Start tracing

{% highlight shell %}
logman start <name> -p <provider_guid_or_name> <kw> <level> -o <output.etl> -ets
{% endhighlight %}

### Examples

{% highlight shell %}
logman start lms -p {3A8FD7D2-CAB3-455D-A8E5-9E1741365FEB} 0x1 win:Verbose -o c:\output.etl -ets
logman start lms -p MyProviderName 0x3 win:Informational -o c:\output.etl -ets
{% endhighlight %}

## Stop tracing

{% highlight shell %}
logman stop <name> -ets
{% endhighlight %}

### Examples

{% highlight shell %}
logman stop lms -ets
{% endhighlight %}

# Collecting ETW traces from test/production systems

To collect ETW trace logs from test/production systems, manifest file and message/resource file need not be registered.

{% highlight shell %}
mftrace -c config.xml -o c:\output.etl
{% endhighlight %}

`c:\output.etl` is just an example. You can use any location and any filename as long as the extension is .etl. The output .etl file can only be read on a system where the manifest file and the resource/message file are registered. To read the traces:

{% highlight shell %}
tracerpt -y output.etl
{% endhighlight %}

The default readable output file that contains all the trace information will be `dumpfile.xml`. A `summary.txt` file will also be generated. For more information about `tracerpt`, have a look at [here](https://technet.microsoft.com/en-us/library/bb490959.aspx).
